include library.create;
include library.utils;


trigger OnAttach()
{
	messageTo(self, "doShuttleSpawnEvent", null, 9, false);
	return SCRIPT_CONTINUE;
}

trigger OnInitialize()
{
	messageTo(self, "doShuttleSpawnEvent", null, 19, false);
	return SCRIPT_CONTINUE;
}

messageHandler doShuttleSpawnEvent()
{
	int maxPop = 1;
	
	if ( utils.hasScriptVar(self, "myCreation") )
	{
		obj_id shuttle = utils.getObjIdScriptVar(self, "myCreation");
		if ( exists(shuttle) )
		{
			return SCRIPT_CONTINUE;
		}
	}

	location where = getLocation(self);	
	string shuttleTemplate = "object/creature/npc/theme_park/kash_rodian_shuttle.iff";
	
	obj_id shuttle = createObject(shuttleTemplate, where);	
	
	if( !isIdValid(shuttle) )
	{
		setName(self , "Rodian Shuttle did not spawn.");
		return SCRIPT_CONTINUE;
	}
	
	float spawnerYaw = getYaw(self);
	setYaw(shuttle, spawnerYaw);
	
	setObjVar(shuttle, "objParent", self);
	attachScript(shuttle, "theme_park.kashyyyk.kash_rodian_shuttle");

	utils.setScriptVar(self, "myCreation", shuttle);
	
	return SCRIPT_CONTINUE;
}

messageHandler shuttleDestroyed()
{
	obj_id deadNpc = params.getObjId("destroyedShuttle");

	if ( !utils.hasScriptVar(self, "myCreation") )
	{
		return SCRIPT_CONTINUE;
	}

	obj_id shuttle = utils.getObjIdScriptVar(self, "myCreation");

	if( shuttle == deadNpc )
	{
		utils.removeScriptVar (self, "myCreation");
		messageTo(self, "doShuttleSpawnEvent", null, 9, false);
	}
	
	return SCRIPT_CONTINUE;
}

trigger OnDestroy()
{
	if ( hasObjVar (self, "myCreation") )
	{
		destroySpawnedShuttles(self);
	}
	return SCRIPT_CONTINUE;
}

void destroySpawnedShuttles(obj_id self)
{
	obj_id shuttle = utils.getObjIdScriptVar(self, "myCreation");
	if ( isIdValid(shuttle) )
	{
		destroyObject(shuttle);
	}
	
	utils.removeScriptVar(self, "myCreation");
	return;
}
