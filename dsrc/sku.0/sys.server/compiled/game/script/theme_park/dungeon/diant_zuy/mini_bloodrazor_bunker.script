include ai.ai;
include library.ai_lib;
include library.create;
include ai.ai_combat;
include library.permissions;

trigger OnAttach()
{
	int sekritCode = rand(1000, 9999);
	setObjVar(self, "diant.sekritCode", sekritCode);
	setObjVar(self, "diant.generator", 1);
	setObjVar(self, "diant.mainframe", 0);
	setObjVar(self, "diant.security", 0);
	setObjVar(self, "diant.remote", 0);
	setObjVar(self, "diant.doorOpened", 0);
	setObjVar(self, "diant.isExploding", 0);
	setObjVar(self, "diant.explosionIntensity", 1.0f);
	setObjVar(self, "diant.intensifying", 0);	
	spawnEveryone(self);
	obj_id lockedRoom = getCellId(self, "pantry");
	permissionsMakePrivate(lockedRoom);

	return SCRIPT_CONTINUE;
}

/*----------------------
trigger OnInitialize()
{
	setObjVar(self, "diant.generator", 1);
	setObjVar(self, "diant.mainframe", 0);
	setObjVar(self, "diant.security", 0);
	setObjVar(self, "diant.remote", 0);
	setObjVar(self, "diant.doorOpened", 0);
	spawnEveryone(self);
	obj_id lockedRoom = getCellId(self, "pantry");
	permissionsMakePrivate(lockedRoom);

	return SCRIPT_CONTINUE;
}
-----------------------*/


void spawnEveryone(obj_id self)
{
	debugSpeakMsg (self, "Spawning Everyone");

	if (!hasScript (self, "theme_park.dungeon.generic_spawner"));
	{
		attachScript (self, "theme_park.dungeon.generic_spawner");
	}

	if (!hasObjVar (self, "spawn_table"))
	{
		setObjVar (self, "spawn_table", "datatables/spawning/dungeon/mini_bloodrazor_bunker.iff");
	}		
	return;
}

messageHandler mainframeFailed()
{
	obj_id spawnCell = getCellId (self, "computer");
	location locOne = getLocation(self);
	location locTwo = getLocation(self);
	
	locOne.x = 7.00f;
	locOne.y = -16.00f;
	locOne.z = 135.00f;
	locOne.cell = spawnCell;
	
	locTwo.x = 0.00f;
	locTwo.y = -16.00f;
	locTwo.z = 135.00f;
	locTwo.cell = spawnCell;
	
	obj_id droidOne = create.object("blood_razor_pirate_elite", locOne);
	obj_id droidTwo = create.object("blood_razor_pirate_elite", locTwo);

	return SCRIPT_CONTINUE;
}

messageHandler openLocks()
{
	obj_id lockedRoom = getCellId(self, "pantry");
	permissionsMakePublic(lockedRoom);
	
	return SCRIPT_CONTINUE;
}

messageHandler selfDestruct()
{
	messageTo (self, "intensifyExplosions", null, 1f, false);

	obj_id[] objPlayers = getPlayerCreaturesInRange(self, 64.0f);

	if (objPlayers != null && objPlayers.length>0)
	{

		for(int i = 0; i < objPlayers.length; i++)
		{
			location myLoc = getLocation(self);	
			playClientEffectLoc(objPlayers[i], "clienteffect/combat_explosion_lair_large.cef", myLoc, 10f);
			myLoc.x += 5.0f;
			playClientEffectLoc(objPlayers[i], "clienteffect/combat_explosion_lair_large.cef", myLoc, 10f);
			myLoc.z += 5.0f;
			playClientEffectLoc(objPlayers[i], "clienteffect/combat_explosion_lair_large.cef", myLoc, 10f);
			myLoc.x -= 10.0f;
			playClientEffectLoc(objPlayers[i], "clienteffect/combat_explosion_lair_large.cef", myLoc, 10f);
			myLoc.z -= 10.0f;
			playClientEffectLoc(objPlayers[i], "clienteffect/combat_explosion_lair_large.cef", myLoc, 10f);	
		}
	}

	destroyObject(self);
	return SCRIPT_CONTINUE;
}

messageHandler jackUpIntensity()
{
	float intensity = getFloatObjVar(self, "diant.explosionIntensity");	
	intensity += 0.1f;
	
	if(intensity>2)
		intensity = 2.6f;
		
	setObjVar(self, "diant.explosionIntensity", intensity);

	return SCRIPT_CONTINUE;
}

messageHandler intensifyExplosions()
{

	int intensifying = getIntObjVar(self, "diant.intensifying");

	if(intensifying == 0)
	{
	intensifying = 1;
	setObjVar(self, "diant.intensifying", intensifying);
	
	messageTo (self, "jackUpIntensity", null, 20f, false);
	messageTo (self, "jackUpIntensity", null, 40f, false);
	messageTo (self, "jackUpIntensity", null, 60f, false);
	messageTo (self, "jackUpIntensity", null, 80f, false);
	messageTo (self, "jackUpIntensity", null, 100f, false);	
	messageTo (self, "jackUpIntensity", null, 120f, false);
	messageTo (self, "jackUpIntensity", null, 140f, false);
	messageTo (self, "jackUpIntensity", null, 160f, false);
	messageTo (self, "jackUpIntensity", null, 180f, false);
	messageTo (self, "jackUpIntensity", null, 200f, false);
	messageTo (self, "jackUpIntensity", null, 220f, false);	
	}

	return SCRIPT_CONTINUE;
}